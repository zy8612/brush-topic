<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ey.security.mapper.SysUserMapper">
    <select id="selectUserList" resultType="com.ey.model.vo.system.SysUserListVo"
            parameterType="com.ey.model.dto.system.SysUserListDto">
        SELECT
        u.id,
        u.account,
        u.avatar,
        u.email,
        u.status,
        u.member_time AS memberTime,
        u.create_time AS createTime,
        r.name AS roleName
        FROM sys_user u
        LEFT JOIN sys_user_role AS ur ON ur.user_id = u.id AND ur.is_deleted = 0
        LEFT JOIN sys_role AS r ON ur.role_id = r.id AND r.is_deleted = 0
        <where>
            u.is_deleted = 0
            <if test="account != null and account != ''">
                AND u.account LIKE CONCAT('%', #{account}, '%')
            </if>
            <if test="roleName != null and roleName != ''">
                AND r.name = #{roleName}
            </if>
            <if test="beginCreateTime != null and beginCreateTime != ''">
                AND DATE(u.create_time) &gt;= DATE(#{beginCreateTime})
            </if>
            <if test="endCreateTime != null and endCreateTime != ''">
                AND DATE(u.create_time) &lt;= DATE(#{endCreateTime})
            </if>
            <if test="beginMemberTime != null and beginMemberTime != ''">
                AND DATE(u.member_time) &gt;= DATE(#{beginMemberTime})
            </if>
            <if test="endMemberTime != null and endMemberTime != ''">
                AND DATE(u.member_time) &lt;= DATE(#{endMemberTime})
            </if>
        </where>
        ORDER BY u.create_time DESC
        <if test="pageNum != null and pageSize != null">
            LIMIT #{pageNum}, #{pageSize}
        </if>
    </select>

    <select id="countUserList" resultType="java.lang.Long"
            parameterType="com.ey.model.dto.system.SysUserListDto">
        SELECT COUNT(*)
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id AND ur.is_deleted = 0
        LEFT JOIN sys_role r ON ur.role_id = r.id AND r.is_deleted = 0
        WHERE u.is_deleted = 0
        <if test="account != null and account != ''">
            and u.account like concat('%', #{account}, '%')
        </if>
        <if test="roleName != null and roleName != ''">
            and r.name = #{roleName}
        </if>
        <if test="beginCreateTime != null and beginCreateTime != ''">
            and date_format(u.create_time,'%Y%m%d') &gt;= date_format(#{beginCreateTime},'%Y%m%d')
        </if>
        <if test="endCreateTime != null and endCreateTime != ''">
            and date_format(u.create_time,'%Y%m%d') &lt;= date_format(#{endCreateTime},'%Y%m%d')
        </if>
        <if test="beginMemberTime != null and beginMemberTime != ''">
            and date_format(u.member_time,'%Y%m%d') &gt;= date_format(#{beginMemberTime},'%Y%m%d')
        </if>
        <if test="endMemberTime != null and endMemberTime != ''">
            and date_format(u.member_time,'%Y%m%d') &lt;= date_format(#{endMemberTime},'%Y%m%d')
        </if>
    </select>

    <select id="selectExportUsers" resultType="com.ey.model.vo.system.SysUserListVo">
        SELECT u.id,
        u.account,
        u.avatar,
        u.email,
        u.status,
        u.member_time AS memberTime,
        u.create_time AS createTime,
        r.name AS roleName
        FROM sys_user u
        LEFT JOIN sys_user_role AS ur ON ur.user_id = u.id AND ur.is_deleted = 0
        LEFT JOIN sys_role AS r ON ur.role_id = r.id AND r.is_deleted = 0
        WHERE u.id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        AND u.is_deleted = 0
        ORDER BY u.create_time DESC
    </select>

    <select id="getByRoleName" resultType="com.ey.model.entity.system.SysRole">
        SELECT id, name, create_time, update_time, identify, remark, role_key
        FROM sys_role
        WHERE name = #{roleName}
          AND is_deleted = 0
    </select>

    <select id="countUserDay7" resultType="com.ey.model.vo.topic.TopicDataVo">
        SELECT date_series.date_value AS date,
        COALESCE(COUNT(u.id), 0) AS count
        FROM (
            SELECT CURDATE() - INTERVAL 6 DAY AS date_value UNION ALL
            SELECT CURDATE() - INTERVAL 5 DAY UNION ALL
            SELECT CURDATE() - INTERVAL 4 DAY UNION ALL
            SELECT CURDATE() - INTERVAL 3 DAY UNION ALL
            SELECT CURDATE() - INTERVAL 2 DAY UNION ALL
            SELECT CURDATE() - INTERVAL 1 DAY UNION ALL
            SELECT CURDATE()
            ) date_series
            LEFT JOIN sys_user u
        ON
            u.create_time &gt;= date_series.date_value AND
            u.create_time &lt; date_series.date_value + INTERVAL 1 DAY
        GROUP BY date_series.date_value
        ORDER BY date_series.date_value;
    </select>

</mapper>